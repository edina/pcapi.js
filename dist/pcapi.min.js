"use strict";var pcapi=function(){var e=function(){localStorage.setItem("cloud-user",JSON.stringify({id:void 0}))},t=function(e,t,i){var s=l.getCloudProviderUrl()+"/auth/"+e;"local"===e?r(t,i,s):o(t,i,s)},r=function(e,t,r){var o,i=0,s=3e3,n=3e5,u=r;console.debug("Login with: "+u);var a=window.open(u,"_blank","location=no"),c=function(t){clearInterval(o),e(t)};console.debug("Poll: "+u),o=setInterval(function(){$.ajax({url:u,timeout:3e3,success:function(e){if(i+=s,"object"==typeof e&&(1===e.state||i>n)){var t;1===e.state&&(t=e.userid,l.setCloudLogin(t)),a.close(),c(t)}},error:function(e){console.error("Problem polling api: "+e.statusText),c()}})},s),t&&t(a)},o=function(t,r,o){var i,s=0,u=3e3,a=3e5,c=n();void 0!==c&&(console.debug("got a user id: "+c),o+="/"+c),e(),console.debug("Login with: "+o+"?async=true"),$.ajax({url:o+"?async=true",timeout:3e3,cache:!1,success:function(e){console.debug("Redirect to: "+e.url);var n=e.userid,c=function(e){clearInterval(i),t(e)},d=window.open(e.url,"_blank","location=no"),f=o+"/"+n+"?async=true";console.debug("Poll: "+f),i=setInterval(function(){$.ajax({url:f,success:function(e){s+=u,(1===e.state||s>a)&&(1===e.state&&l.setCloudLogin(n),d.close(),c(n))},error:function(e){console.error("Problem polling api: "+e.statusText),c({status:-1,msg:"Problem polling api"})},cache:!1})},u),r&&r(d)},error:function(e,r){var o;void 0===r?r=" Unspecified Error.":o="timeout"===r?"Unable to login, please enable data connection.":"Problem with login: "+r,t({status:-1,msg:o}),console.error(o)}})},i=function(e,t,r,o){return new Promise(function(i,s){var n=new XMLHttpRequest;"GET"===e&&r&&(t+="?"+Object.keys(r).map(function(e){return encodeURIComponent(e)+"="+encodeURIComponent(r[e])}).join("&")),n.open(e,t),n.onload=function(){200==n.status?1===n.response.error?s(Error(n.response.msg)):i(n.response):s(Error(n.statusText))},n.onerror=function(){s(Error("Network Error"))},"POST"===e||"PUT"===e?(o?n.setRequestHeader("Content-type",o):n.setRequestHeader("Content-type","application/x-www-form-urlencoded"),n.send(r)):n.send()})},s=function(){var e=null,t=localStorage.getItem("cloud-user");return t&&(e=JSON.parse(t)),e},n=function(){var e,t=s();return"object"==typeof t&&(e=t.id),e},u=function(e){var t=[];if("object"==typeof e)for(var r in e)e.hasOwnProperty(r)&&t.push(encodeURIComponent(r)+"="+encodeURIComponent(e[r]));return t.join("&")},l={init:function(e){this.baseUrl=e.url,this.version=e.version,this.cloudProviderUrl=e.url+"/"+e.version+"/pcapi"},buildUrl:function(e,t,r){var o=n();return this.buildUserUrl(o,e,t,r)},buildUserUrl:function(e,t,r,o){r=r||"";var i=u(o);return i.length>0&&(i="?"+i),this.getCloudProviderUrl()+"/"+t+"/"+this.getProvider()+"/"+e+"/"+r+i},buildFSUrl:function(e,t){var r=n();return this.buildFSUserUrl(r,e,t)},buildFSUserUrl:function(e,t,r){return r=r||"",""!==e&&(e="/"+e),this.getCloudProviderUrl()+"/fs/"+this.getProvider()+e+"/"+t+"/"+r},checkLogin:function(e){if(this.userId)e(this.userId);else{console.log("check if user is logged in");var t=s();if(null!==t&&t.id){var r=this.getCloudProviderUrl()+"/auth/"+this.getProvider();"local"!==t.id&&(r+="/"+t.id),console.debug("Check user with: "+r),$.ajax({url:r,type:"GET",dataType:"json",cache:!1,success:$.proxy(function(r){1===r.state&&this.setCloudLogin(t.id,t.cursor),e(!0,r)},this),error:function(t,r,o){e(!1,o)}})}else console.debug("No user session saved"),this.logoutCloud()}},deleteItem:function(e,t,r){r=r||n();var o=this.buildFSUserUrl(r,e,t);return console.debug("Delete item from "+e+" with "+o),new Promise(function(e,t){i("DELETE",o).then(function(t){e(JSON.parse(t))},function(e){console.error("Problem with "+o+" : status="+status+" : "+e),t(Error("Problem with "+o+" : status="+status+" : "+e))})})},getAssets:function(){var e={remoteDir:"records",extras:"assets/images/",filters:{frmt:"url"}};return this.getItems(e)},getBaseUrl:function(){return this.baseUrl},getCloudProviderUrl:function(){return this.cloudProviderUrl},getFSItems:function(e,t){t=t||n();var r=this.buildFSUserUrl(t,e);return console.debug("Get items of "+e+" with "+r),new Promise(function(e,t){i("GET",r).then(function(t){e(JSON.parse(t))},function(e){console.error("Problem with "+r+" : status="+status+" : "+e),t(Error("Problem with "+r+" : status="+status+" : "+e))})})},getFSItem:function(e){var t=e.userId||n(),r=this.buildFSUserUrl(t,e.remoteDir,e.item);return console.debug("Get item "+e.item+" of "+e.remoteDir+" with "+r),new Promise(function(t,o){i("GET",r).then(function(r){t("records"===e.remoteDir?JSON.parse(r):r)},function(e){console.error("Problem with "+r+" : status="+status+" : "+e),o(Error("Problem with "+r+" : status="+status+" : "+e))})})},getItem:function(e){var t=e.userId||n(),r=this.buildUserUrl(t,e.remoteDir,e.item);return console.debug("Get item "+e.item+" of "+e.remoteDir+" with "+r),new Promise(function(t,o){i("GET",r).then(function(r){t("records"===e.remoteDir?JSON.parse(r):r)},function(e){console.error("Problem with "+r+" : status="+status+" : "+e),o(Error("Problem with "+r+" : status="+status+" : "+e))})})},getItems:function(e){var t=e.userId||n(),r=this.buildUserUrl(t,e.remoteDir,e.extras);return console.debug("Get items of "+e.remoteDir+" with "+r),void 0===e.filters&&(e.filters={}),console.log("with filters "+JSON.stringify(e.filters)),new Promise(function(t,o){i("GET",r,e.filters).then(function(e){t(JSON.parse(e))},function(e){console.error("Problem with "+r+" : status="+status+" : "+e),o(Error("Problem with "+r+" : status="+status+" : "+e))})})},getParameters:function(){for(var e=window.location.search.substring(1),t={},r=e.split("&"),o=0;o<r.length;o++){var i=r[o].split("=");if("undefined"==typeof t[i[0]])t[i[0]]=i[1];else if("string"==typeof t[i[0]]){var s=[t[i[0]],i[1]];t[i[0]]=s}else t[i[0]].push(i[1])}return t},getProviders:function(){var e=this.getCloudProviderUrl()+"/auth/providers";return new Promise(function(t,r){i("GET",e).then(function(e){t(JSON.parse(e))},function(t){console.error("Problem with "+e+" : status="+status+" : "+t),r(Error("Problem with "+e+" : status="+status+" : "+t))})})},getProvider:function(){return localStorage.getItem("cloud-provider")||"local"},getUser:function(){return this.user},getUserId:function(){var e=n();return e},loginAsyncCloud:function(e,r,o){t(e,r,o)},loginCloud:function(){if(!("uid"in this.getParameters())){var e=this.getCloudProviderUrl()+"/auth/"+this.getProvider()+"?callback="+$(location).attr("href");$.getJSON(e,function(e){$(location).attr("href",e.url)})}},logoutCloud:function(){e()},saveItem:function(e){var t,r,o,s=e.userId||n();return"records"===e.remoteDir?(t=JSON.stringify(e.data,void 0,2),r=e.path,o=this.buildUserUrl(s,e.remoteDir,r)):"editors"===e.remoteDir?(t=e.data,r=e.path+".edtr",o=this.buildUserUrl(s,e.remoteDir,r)):o=this.buildFSUserUrl(s,e.remoteDir,r),console.debug("Post item to "+e.remoteDir+" with "+o),new Promise(function(e,r){i("POST",o,t).then(function(t){e(JSON.parse(t))},function(e){console.error("Problem with "+o+" : status="+status+" : "+e),r(Error("Problem with "+o+" : status="+status+" : "+e))})})},setBaseUrl:function(e){this.baseUrl=e},setCloudLogin:function(e,t){this.user={id:e,cursor:t},localStorage.setItem("cloud-user",JSON.stringify(this.user))},setCloudProviderUrl:function(e){this.cloudProviderUrl=e+"/"+this.version+"/pcapi"},setProvider:function(e){localStorage.setItem("cloud-provider",e)},setUserId:function(e){this.userId=e},updateItem:function(e){var t,r,o,s=e.userId||n();return"records"===e.remoteDir?(t=JSON.stringify(e.data,void 0,2),r=e.path,o=this.buildUserUrl(s,e.remoteDir,r)):"editors"===e.remoteDir?(t=e.data,r=e.path+".edtr",o=this.buildUserUrl(s,e.remoteDir,r)):o=this.buildFSUserUrl(s,e.remoteDir,r),console.debug("PUT item to "+e.remoteDir+" with "+o),new Promise(function(e,r){i("PUT",o,t).then(function(t){e(JSON.parse(t))},function(e){console.error("Problem with "+o+" : status="+status+" : "+e),r(Error("Problem with "+o+" : status="+status+" : "+e))})})},uploadFile:function(e){var t=e.userid||n(),r=this.buildUserUrl(t,"fs",e.remoteDir+"/"+e.path);console.debug("Upload item "+e.file.name+" to "+e.remoteDir+" with "+r);var o=new FormData;return o.append("upload",e.file),new Promise(function(t,s){i("POST",r,o,e.contentType).then(function(e){t(JSON.parse(e))},function(e){console.error("Problem with "+r+" : status="+status+" : "+e),s(Error("Problem with "+r+" : status="+status+" : "+e))})})}};return l}();