"use strict";var pcapi=function(){var e=["editors","layers","records"],t=function(){localStorage.setItem("cloud-user",JSON.stringify({id:void 0}))},r=function(e,t,r){var n=a.getCloudProviderUrl()+"/auth/"+e;"local"===e?o(t,r,n):i(t,r,n)},o=function(e,t,r){var o,i=0,n=3e3,s=3e5,u=r;console.debug("Login with: "+u);var l=window.open(u,"_blank","location=no"),c=function(t){clearInterval(o),e(t)};console.debug("Poll: "+u),o=setInterval(function(){$.ajax({url:u,timeout:3e3,success:function(e){if(i+=n,"object"==typeof e&&(1===e.state||i>s)){var t;1===e.state&&(t=e.userid,a.setCloudLogin(t)),l.close(),c(t)}},error:function(e){console.error("Problem polling api: "+e.statusText),c()}})},n),t&&t(l)},i=function(e,r,o){var i,n=0,s=3e3,l=3e5,c=u();void 0!==c&&(console.debug("got a user id: "+c),o+="/"+c),t(),console.debug("Login with: "+o+"?async=true"),$.ajax({url:o+"?async=true",timeout:3e3,cache:!1,success:function(t){console.debug("Redirect to: "+t.url);var u=t.userid,c=function(t){clearInterval(i),e(t)},d=window.open(t.url,"_blank","location=no"),f=o+"/"+u+"?async=true";console.debug("Poll: "+f),i=setInterval(function(){$.ajax({url:f,success:function(e){n+=s,(1===e.state||n>l)&&(1===e.state&&a.setCloudLogin(u),d.close(),c(u))},error:function(e){console.error("Problem polling api: "+e.statusText),c({status:-1,msg:"Problem polling api"})},cache:!1})},s),r&&r(d)},error:function(t,r){var o;void 0===r?r=" Unspecified Error.":o="timeout"===r?"Unable to login, please enable data connection.":"Problem with login: "+r,e({status:-1,msg:o}),console.error(o)}})},n=function(e,t,r,o){return new Promise(function(i,n){var s=new XMLHttpRequest;"GET"===e&&r&&(t+="?"+Object.keys(r).map(function(e){return encodeURIComponent(e)+"="+encodeURIComponent(r[e])}).join("&")),s.open(e,t),s.onload=function(){200==s.status?1===s.response.error?n(Error(s.response.msg)):i(s.response):n(Error(s.statusText))},s.onerror=function(){n(Error("Network Error"))},"POST"===e||"PUT"===e?(o?s.setRequestHeader("Content-type",o):s.setRequestHeader("Content-type","application/x-www-form-urlencoded"),s.send(r)):s.send()})},s=function(){var e=null,t=localStorage.getItem("cloud-user");return t&&(e=JSON.parse(t)),e},u=function(){var e,t=s();return"object"==typeof t&&(e=t.id),e},l=function(e){var t=[];if("object"==typeof e)for(var r in e)e.hasOwnProperty(r)&&t.push(encodeURIComponent(r)+"="+encodeURIComponent(e[r]));return t.join("&")},a={init:function(e){this.baseUrl=e.url,this.version=e.version,this.cloudProviderUrl=e.url+"/"+e.version+"/pcapi"},buildUrl:function(e,t,r){var o=u();return this.buildUserUrl(o,e,t,r)},buildUserUrl:function(e,t,r,o){r=r||"";var i=l(o);return i.length>0&&(i="?"+i),this.getCloudProviderUrl()+"/"+t+"/"+this.getProvider()+"/"+e+"/"+r+i},buildFSUrl:function(e,t){var r=u();return this.buildFSUserUrl(r,e,t)},buildFSUserUrl:function(e,t,r){return r=r||"",""!==e&&(e="/"+e),this.getCloudProviderUrl()+"/fs/"+this.getProvider()+e+"/"+t+"/"+r},checkLogin:function(e){if(this.userId)e(this.userId);else{console.log("check if user is logged in");var t=s();if(null!==t&&t.id){var r=this.getCloudProviderUrl()+"/auth/"+this.getProvider();"local"!==t.id&&(r+="/"+t.id),console.debug("Check user with: "+r),$.ajax({url:r,type:"GET",dataType:"json",cache:!1,success:$.proxy(function(r){1===r.state&&this.setCloudLogin(t.id,t.cursor),e(!0,r)},this),error:function(t,r,o){e(!1,o)}})}else console.debug("No user session saved"),this.logoutCloud()}},deleteItem:function(e,t,r){r=r||u();var o=this.buildFSUserUrl(r,e,t);return console.debug("Delete item from "+e+" with "+o),new Promise(function(e,t){n("DELETE",o).then(function(t){e(JSON.parse(t))},function(e){console.error("Problem with "+o+" : status="+status+" : "+e),t(Error("Problem with "+o+" : status="+status+" : "+e))})})},getAssets:function(){var e={remoteDir:"records",extras:"assets/images/",filters:{frmt:"url"}};return this.getItems(e)},getBaseUrl:function(){return this.baseUrl},getCloudProviderUrl:function(){return this.cloudProviderUrl},getFSItems:function(e,t){t=t||u();var r=this.buildFSUserUrl(t,e);return console.debug("Get items of "+e+" with "+r),new Promise(function(e,t){n("GET",r).then(function(t){e(JSON.parse(t))},function(e){console.error("Problem with "+r+" : status="+status+" : "+e),t(Error("Problem with "+r+" : status="+status+" : "+e))})})},getFSItem:function(e){var t=e.userId||u(),r=this.buildFSUserUrl(t,e.remoteDir,e.item);return console.debug("Get item "+e.item+" of "+e.remoteDir+" with "+r),new Promise(function(t,o){n("GET",r).then(function(r){t("records"===e.remoteDir?JSON.parse(r):r)},function(e){console.error("Problem with "+r+" : status="+status+" : "+e),o(Error("Problem with "+r+" : status="+status+" : "+e))})})},getItem:function(e){var t=e.userId||u(),r=this.buildUserUrl(t,e.remoteDir,e.item);return console.debug("Get item "+e.item+" of "+e.remoteDir+" with "+r),new Promise(function(t,o){n("GET",r).then(function(r){t("records"===e.remoteDir?JSON.parse(r):r)},function(e){console.error("Problem with "+r+" : status="+status+" : "+e),o(Error("Problem with "+r+" : status="+status+" : "+e))})})},getItems:function(e){var t=e.userId||u(),r=this.buildUserUrl(t,e.remoteDir,e.extras);return console.debug("Get items of "+e.remoteDir+" with "+r),void 0===e.filters&&(e.filters={}),console.log("with filters "+JSON.stringify(e.filters)),new Promise(function(t,o){n("GET",r,e.filters).then(function(e){t(JSON.parse(e))},function(e){console.error("Problem with "+r+" : status="+status+" : "+e),o(Error("Problem with "+r+" : status="+status+" : "+e))})})},getParameters:function(){for(var e=window.location.search.substring(1),t={},r=e.split("&"),o=0;o<r.length;o++){var i=r[o].split("=");if("undefined"==typeof t[i[0]])t[i[0]]=i[1];else if("string"==typeof t[i[0]]){var n=[t[i[0]],i[1]];t[i[0]]=n}else t[i[0]].push(i[1])}return t},getProviders:function(){var e=this.getCloudProviderUrl()+"/auth/providers";return new Promise(function(t,r){n("GET",e).then(function(e){t(JSON.parse(e))},function(t){console.error("Problem with "+e+" : status="+status+" : "+t),r(Error("Problem with "+e+" : status="+status+" : "+t))})})},getProvider:function(){return localStorage.getItem("cloud-provider")||"local"},getUser:function(){return this.user},getUserId:function(){var e=u();return e},loginAsyncCloud:function(e,t,o){r(e,t,o)},loginCloud:function(){if(!("uid"in this.getParameters())){var e=this.getCloudProviderUrl()+"/auth/"+this.getProvider()+"?callback="+$(location).attr("href");$.getJSON(e,function(e){$(location).attr("href",e.url)})}},logoutCloud:function(){t()},objectToURL:function(e){var t=[];if("object"==typeof e)for(var r in e)e.hasOwnProperty(r)&&t.push(encodeURIComponent(r)+"="+encodeURIComponent(e[r]));return t.join("&")},saveItem:function(e){var t,r,o,i=e.userId||u();return"records"===e.remoteDir?(t=JSON.stringify(e.data,void 0,2),r=e.path,o=this.buildUserUrl(i,e.remoteDir,r)):"editors"===e.remoteDir?(t=e.data,r=e.path+".edtr",o=this.buildUserUrl(i,e.remoteDir,r)):o=this.buildFSUserUrl(i,e.remoteDir,r),console.debug("Post item to "+e.remoteDir+" with "+o),new Promise(function(e,r){n("POST",o,t).then(function(t){e(JSON.parse(t))},function(e){console.error("Problem with "+o+" : status="+status+" : "+e),r(Error("Problem with "+o+" : status="+status+" : "+e))})})},setBaseUrl:function(e){this.baseUrl=e},setCloudLogin:function(e,t){this.user={id:e,cursor:t},localStorage.setItem("cloud-user",JSON.stringify(this.user))},setCloudProviderUrl:function(e){this.cloudProviderUrl=e+"/"+this.version+"/pcapi"},setProvider:function(e){localStorage.setItem("cloud-provider",e)},setUserId:function(e){this.userId=e},updateItem:function(e){var t,r,o,i=e.userId||u();return"records"===e.remoteDir?(t=JSON.stringify(e.data,void 0,2),r=e.path,o=this.buildUserUrl(i,e.remoteDir,r)):"editors"===e.remoteDir?(t=e.data,r=e.path+".edtr",o=this.buildUserUrl(i,e.remoteDir,r)):o=this.buildFSUserUrl(i,e.remoteDir,r),console.debug("PUT item to "+e.remoteDir+" with "+o),new Promise(function(e,r){n("PUT",o,t).then(function(t){e(JSON.parse(t))},function(e){console.error("Problem with "+o+" : status="+status+" : "+e),r(Error("Problem with "+o+" : status="+status+" : "+e))})})},uploadFile:function(t){var r=t.userid||u(),o=this.buildFSUserUrl(r,t.remoteDir,t.path);e.indexOf(t.remoteDir)>-1&&(o=this.buildUserUrl(r,t.remoteDir,t.path,t.urlParams)),console.debug("Upload item "+t.file.name+" to "+t.remoteDir+" with "+o);var i=new FormData;return i.append("upload",t.file),new Promise(function(e,r){n("POST",o,i,t.contentType).then(function(t){e(JSON.parse(t))},function(e){console.error("Problem with "+o+" : status="+status+" : "+e),r(Error("Problem with "+o+" : status="+status+" : "+e))})})}};return a}();"object"==typeof module&&"object"==typeof module.exports?module.exports=pcapi:"function"==typeof define&&define.amd&&define(["pcapi"],function(){return pcapi}),"object"==typeof window&&"object"==typeof window.document&&(window.pcapi=pcapi);